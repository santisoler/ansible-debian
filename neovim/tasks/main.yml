- name: Install Neovim dependencies and useful packages
  become: true
  package:
    name:
      - "{{ item }}"
    state: present
  loop: "{{ dependencies }}"

- name: Download Neovim
  ansible.builtin.get_url:
    url: "https://github.com/neovim/neovim/releases/latest/download/nvim-linux64.tar.gz"
    dest: /tmp/nvim-linux64.tar.gz
    mode: '655'
  register: download_result
  until: download_result is succeeded
  retries: 3
  delay: 5

- name: Create /opt/nvim directory
  become: true
  ansible.builtin.file:
    path: /opt/nvim
    state: directory
    owner: root
    group: root
    mode: '755'

- name: Unpack it
  become: true
  ansible.builtin.unarchive:
    src: /tmp/nvim-linux64.tar.gz
    dest: /opt/

- name: Create symlink
  become: true
  ansible.builtin.file:
    src: /opt/nvim-linux64/bin/nvim
    dest: /usr/local/bin/nvim
    state: link
    owner: root
    group: root
    mode: '755'

- name: Clone dotfiles
  ansible.builtin.git:
    repo: 'https://github.com/santisoler/dotfiles'
    dest: '~/.dotfiles'
    clone: yes
    update: yes

- name: Stow Neovim configs
  ansible.builtin.shell: |
    cd ~/.dotfiles
    stow nvim

# - name: Install packages with packer
#   ansible.builtin.shell: |
#     nvim --headless -c 'autocmd User PackerComplete quitall' -c 'PackerSync'
# 
# - name: Install lsp and linters with Mason
#   ansible.builtin.shell: |
#     nvim --headless -c 'lua MasonAutoInstall(false)' -c "quitall"
